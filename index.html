<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="BP Tracker">
<title>BP Tracker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, 'Avenir', 'Nunito', 'Segoe UI', sans-serif;
    background: #F0EDE6; color: #1A1A1A;
    max-width: 480px; margin: 0 auto; padding: 0 16px 60px;
    min-height: 100vh; -webkit-font-smoothing: antialiased;
  }
  .header { text-align: center; padding: 28px 0 12px; }
  .header h1 { font-size: 24px; font-weight: 700; color: #2D5F46; }
  .header p { font-size: 13px; color: #8A8778; margin-top: 4px; }
  .sync-status { text-align: center; font-size: 11px; padding: 4px 0 8px; font-weight: 600; }
  .tabs { display: flex; border-bottom: 2px solid #EAE7E0; margin-bottom: 16px; }
  .tab {
    flex: 1; padding: 10px 0; border: none; background: none;
    font-size: 14px; font-weight: 600; cursor: pointer;
    font-family: inherit; border-bottom: 2.5px solid transparent;
    color: #8A8778; transition: all 0.2s;
  }
  .tab.active { color: #3A7D5C; border-bottom-color: #3A7D5C; }
  .card {
    background: #FFF; border-radius: 16px; padding: 20px;
    margin-bottom: 14px; border: 1px solid #EAE7E0;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  }
  .sec-title {
    font-size: 13px; font-weight: 700; color: #2D5F46;
    text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 14px;
  }
  .scan-area {
    border: 2px dashed #DDD9CF; border-radius: 12px;
    padding: 24px 16px; text-align: center; cursor: pointer;
    background: #FAFAF7; transition: all 0.2s;
  }
  .scan-area:active { background: #D4E8DB; border-color: #3A7D5C; }
  .scan-icon { font-size: 32px; margin-bottom: 6px; }
  .scan-title { font-size: 15px; font-weight: 600; color: #2D5F46; }
  .scan-sub { font-size: 12px; color: #8A8778; margin-top: 4px; }
  .scan-msg {
    margin-top: 10px; padding: 8px 12px; border-radius: 8px;
    font-size: 13px; font-weight: 600; word-break: break-word;
  }
  .scan-msg.success { background: #D4E8DB; color: #3A7D5C; }
  .scan-msg.error { background: #FFF3E0; color: #D4873C; }
  .scan-msg.scanning { background: #D4E8DB; color: #3A7D5C; }
  .row { display: flex; gap: 10px; margin-bottom: 12px; }
  .field { flex: 1; }
  .label {
    display: block; font-size: 11px; font-weight: 700; color: #8A8778;
    text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 5px;
  }
  input, textarea {
    width: 100%; padding: 10px 12px; border-radius: 8px;
    border: 1.5px solid #DDD9CF; font-size: 16px; font-family: inherit;
    color: #1A1A1A; background: #FFF; outline: none;
  }
  input:focus, textarea:focus { border-color: #3A7D5C; }
  textarea { font-size: 14px; resize: vertical; min-height: 56px; }
  .preview {
    padding: 8px 14px; border-radius: 10px; margin-bottom: 12px;
    display: flex; align-items: center; gap: 8px;
  }
  .preview-num { font-size: 22px; font-weight: 700; }
  .badge {
    display: inline-block; padding: 2px 10px; border-radius: 20px;
    font-size: 11px; font-weight: 700;
  }
  .btns { display: flex; gap: 10px; }
  .btn {
    display: inline-flex; align-items: center; justify-content: center;
    padding: 12px 24px; border-radius: 10px; border: none;
    font-weight: 600; font-size: 15px; cursor: pointer; font-family: inherit;
  }
  .btn-pri { background: #3A7D5C; color: #FFF; flex: 1; }
  .btn-pri:disabled { opacity: 0.4; cursor: default; }
  .btn-out { background: transparent; color: #3A7D5C; border: 1.5px solid #3A7D5C; }
  .reading {
    padding: 14px 16px; border-radius: 12px; background: #FAFAF7;
    border: 1px solid #EAE7E0; margin-bottom: 10px;
  }
  .reading-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
  .reading-date { font-size: 12px; color: #8A8778; font-weight: 600; }
  .reading-vals { display: flex; gap: 16px; align-items: baseline; }
  .reading-bp { font-size: 26px; font-weight: 700; }
  .reading-slash { font-size: 14px; color: #8A8778; }
  .reading-unit { font-size: 12px; color: #8A8778; margin-left: 4px; }
  .reading-pulse { font-size: 20px; font-weight: 700; color: #D4A03C; }
  .reading-del {
    margin-left: auto; background: none; border: none;
    cursor: pointer; color: #8A8778; font-size: 18px; padding: 4px;
  }
  .reading-notes {
    font-size: 13px; color: #555549; line-height: 1.4;
    border-top: 1px solid #EAE7E0; padding-top: 8px; margin-top: 8px;
  }
  .empty { text-align: center; padding: 30px 0; color: #8A8778; }
  .empty-icon { font-size: 36px; margin-bottom: 8px; }
  .chart-wrap { margin-bottom: 24px; }
  .chart-label {
    font-size: 12px; font-weight: 700; color: #8A8778;
    text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 10px;
  }
  .footer {
    text-align: center; padding: 16px 0; font-size: 11px;
    color: #8A8778; line-height: 1.6;
  }
  .settings-toggle { text-align: center; margin-bottom: 10px; }
  .settings-toggle button {
    background: none; border: none; color: #8A8778; font-size: 13px;
    cursor: pointer; font-family: inherit; text-decoration: underline;
  }
  .api-key-input {
    width: 100%; padding: 10px 12px; border-radius: 8px;
    border: 1.5px solid #DDD9CF; font-size: 14px; font-family: monospace;
    color: #1A1A1A; background: #FFF; outline: none;
  }
  .api-key-input:focus { border-color: #3A7D5C; }
  .api-status {
    margin-top: 8px; font-size: 12px; font-weight: 600;
    padding: 6px 10px; border-radius: 6px;
  }
  .api-status.ok { background: #D4E8DB; color: #3A7D5C; }
  .api-status.missing { background: #FFF3E0; color: #D4873C; }
  .progress-bar {
    height: 4px; background: #EAE7E0; border-radius: 2px;
    margin-top: 10px; overflow: hidden;
  }
  .progress-fill {
    height: 100%; background: #3A7D5C; border-radius: 2px;
    transition: width 0.3s;
  }
  .hidden { display: none; }
  #file-input { display: none; }
</style>
</head>
<body>

<div class="header">
  <h1>&#9829; BP Tracker</h1>
  <p>Snap &middot; Log &middot; Track</p>
</div>
<div id="sync-status" class="sync-status" style="color:#8A8778">Loading...</div>

<div class="tabs">
  <button class="tab active" onclick="showTab('add')">&#xFF0B; New</button>
  <button class="tab" onclick="showTab('history')">History</button>
  <button class="tab" onclick="showTab('charts')">Charts</button>
</div>

<div id="tab-add">
  <div class="card">
    <div class="sec-title">&#128247; Scan Monitor</div>
    <div class="scan-area" onclick="document.getElementById('file-input').click()">
      <div class="scan-icon">&#128248;</div>
      <div class="scan-title">Tap to take a photo</div>
      <div class="scan-sub">Point at your BP monitor screen</div>
    </div>
    <div id="scan-key-status" style="margin-top:8px;font-size:12px;text-align:center"></div>
    <input type="file" id="file-input" accept="image/*" capture="environment" onchange="handlePhoto(this)">
    <div id="scan-msg" class="scan-msg hidden"></div>
    <div id="progress" class="progress-bar hidden"><div id="progress-fill" class="progress-fill" style="width:0%"></div></div>
  </div>

  <div class="card">
    <div class="sec-title">Readings</div>
    <div class="row">
      <div class="field">
        <label class="label">Systolic</label>
        <input type="number" inputmode="numeric" id="systolic" placeholder="120" oninput="updatePreview()">
      </div>
      <div class="field">
        <label class="label">Diastolic</label>
        <input type="number" inputmode="numeric" id="diastolic" placeholder="80" oninput="updatePreview()">
      </div>
      <div class="field">
        <label class="label">Pulse</label>
        <input type="number" inputmode="numeric" id="pulse" placeholder="72">
      </div>
    </div>
    <div id="preview" class="preview hidden">
      <span id="preview-num" class="preview-num"></span>
      <span id="preview-badge" class="badge"></span>
    </div>
    <div style="margin-bottom:12px">
      <label class="label">Date &amp; Time</label>
      <input type="datetime-local" id="datetime">
    </div>
    <div style="margin-bottom:16px">
      <label class="label">Notes (optional)</label>
      <textarea id="notes" placeholder="e.g. after coffee, felt dizzy, took meds..." rows="2"></textarea>
    </div>
    <div class="btns">
      <button class="btn btn-pri" id="save-btn" disabled onclick="saveReading()">Save Reading</button>
      <button class="btn btn-out" onclick="clearForm()">Clear</button>
    </div>
  </div>
</div>

<div id="tab-history" class="hidden">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div class="sec-title">All Readings</div>
      <span id="total-count" style="font-size:12px;color:#8A8778"></span>
    </div>
    <div id="readings-list"></div>
  </div>
</div>

<div id="tab-charts" class="hidden">
  <div class="card">
    <div class="sec-title">Trends</div>
    <div id="charts-empty" class="empty">Need at least 2 readings for charts</div>
    <div id="charts-content" class="hidden">
      <div class="chart-wrap">
        <div class="chart-label">Blood Pressure</div>
        <canvas id="bp-chart"></canvas>
      </div>
      <div class="chart-wrap">
        <div class="chart-label">Pulse</div>
        <canvas id="pulse-chart"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="footer">
  Normal: &lt;120/80 &middot; Elevated: 120-129/&lt;80<br>
  High Stage 1: 130-139/80-89 &middot; Stage 2: &ge;140/&ge;90
</div>

<div class="settings-toggle">
  <button onclick="toggleSettings()">&#9881;&#65039; API Key Settings</button>
</div>

<div id="settings-panel" class="card hidden">
  <div class="sec-title">&#128273; Claude API Key</div>
  <p style="font-size:13px;color:#555549;margin-bottom:10px;line-height:1.4">
    Needed for camera scanning. Get one at
    <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:#3A7D5C">console.anthropic.com</a>
  </p>
  <input type="password" class="api-key-input" id="api-key" placeholder="sk-ant-..." oninput="saveApiKey()">
  <div id="api-status"></div>
  <div style="margin-top:8px;font-size:11px;color:#8A8778;line-height:1.4">
    Your key is stored only on this device.<br>
    Do NOT use Private/Incognito mode or the key will be erased.
  </div>
</div>

<script>
var SUPA_URL = "https://jzpipxvxrtdhmsdkveog.supabase.co";
var SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6cGlweHZ4cnRkaG1zZGt2ZW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTE1MjUsImV4cCI6MjA4NTMyNzUyNX0.7mm0ts91y0leGKLFCgRk6KJitah3V5WJZdiD_gHL57o";
var SUPA_HEADERS = {
  "apikey": SUPA_KEY,
  "Authorization": "Bearer " + SUPA_KEY,
  "Content-Type": "application/json",
  "Prefer": "return=representation"
};

var readings = [];

async function fetchReadings() {
  try {
    var res = await fetch(SUPA_URL + "/rest/v1/bp_readings?order=reading_datetime.desc", { headers: SUPA_HEADERS });
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  } catch (e) {
    setSyncStatus("Offline - could not load", "#D4873C");
    return [];
  }
}

async function insertReading(entry) {
  try {
    var res = await fetch(SUPA_URL + "/rest/v1/bp_readings", {
      method: "POST", headers: SUPA_HEADERS, body: JSON.stringify(entry)
    });
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  } catch (e) {
    setSyncStatus("Could not save: " + e.message, "#D4873C");
    return null;
  }
}

async function deleteReadingDB(id) {
  try {
    await fetch(SUPA_URL + "/rest/v1/bp_readings?id=eq." + id, {
      method: "DELETE", headers: SUPA_HEADERS
    });
  } catch (e) { console.error(e); }
}

function setSyncStatus(text, color) {
  var el = document.getElementById("sync-status");
  el.textContent = text;
  el.style.color = color || "#8A8778";
}

async function loadReadings() {
  setSyncStatus("Syncing...", "#8A8778");
  readings = await fetchReadings();
  setSyncStatus("Synced - " + readings.length + " readings", "#3A7D5C");
}

function classify(sys, dia) {
  var s = +sys, d = +dia;
  if (!s || !d) return { label: "-", color: "#8A8778", bg: "#8A877818" };
  if (s < 120 && d < 80) return { label: "Normal", color: "#3A7D5C", bg: "#3A7D5C18" };
  if (s < 130 && d < 80) return { label: "Elevated", color: "#D4873C", bg: "#D4873C18" };
  if (s < 140 || d < 90) return { label: "High - Stage 1", color: "#D4573B", bg: "#D4573B18" };
  return { label: "High - Stage 2", color: "#C42B2B", bg: "#C42B2B18" };
}

function fmtDate(iso) { return new Date(iso).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" }); }
function fmtTime(iso) { return new Date(iso).toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" }); }
function fmtShort(iso) { return new Date(iso).toLocaleDateString("en-US", { month: "short", day: "numeric" }); }
function localNow() {
  var n = new Date();
  return new Date(n.getTime() - n.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
}

function showTab(name) {
  document.querySelectorAll(".tab").forEach(function(t, i) {
    t.classList.toggle("active", ["add","history","charts"][i] === name);
  });
  ["add","history","charts"].forEach(function(t) {
    document.getElementById("tab-" + t).classList.toggle("hidden", t !== name);
  });
  if (name === "history") { loadReadings().then(renderHistory); }
  if (name === "charts") { loadReadings().then(renderCharts); }
}

function updatePreview() {
  var sys = document.getElementById("systolic").value;
  var dia = document.getElementById("diastolic").value;
  var preview = document.getElementById("preview");
  var btn = document.getElementById("save-btn");
  if (sys && dia) {
    var c = classify(sys, dia);
    document.getElementById("preview-num").textContent = sys + "/" + dia;
    document.getElementById("preview-num").style.color = c.color;
    document.getElementById("preview-badge").textContent = c.label;
    document.getElementById("preview-badge").style.color = c.color;
    document.getElementById("preview-badge").style.background = c.bg;
    preview.style.background = c.bg;
    preview.style.border = "1px solid " + c.color + "30";
    preview.classList.remove("hidden");
    btn.disabled = false;
  } else {
    preview.classList.add("hidden");
    btn.disabled = true;
  }
}

function clearForm() {
  document.getElementById("systolic").value = "";
  document.getElementById("diastolic").value = "";
  document.getElementById("pulse").value = "";
  document.getElementById("datetime").value = localNow();
  document.getElementById("notes").value = "";
  document.getElementById("scan-msg").classList.add("hidden");
  document.getElementById("progress").classList.add("hidden");
  updatePreview();
}

async function saveReading() {
  var sys = document.getElementById("systolic").value;
  var dia = document.getElementById("diastolic").value;
  if (!sys || !dia) return;
  var btn = document.getElementById("save-btn");
  btn.disabled = true;
  btn.textContent = "Saving...";
  var dt = document.getElementById("datetime").value;
  var entry = {
    systolic: parseInt(sys),
    diastolic: parseInt(dia),
    pulse: document.getElementById("pulse").value ? parseInt(document.getElementById("pulse").value) : null,
    reading_datetime: new Date(dt).toISOString(),
    notes: document.getElementById("notes").value || null
  };
  var result = await insertReading(entry);
  if (result) {
    await loadReadings();
    clearForm();
    showTab("history");
  }
  btn.disabled = false;
  btn.textContent = "Save Reading";
}

function showScanMsg(text, type) {
  var el = document.getElementById("scan-msg");
  el.textContent = text;
  el.className = "scan-msg " + type;
  el.classList.remove("hidden");
}

function showProgress(pct) {
  var bar = document.getElementById("progress");
  bar.classList.remove("hidden");
  document.getElementById("progress-fill").style.width = pct + "%";
}

function getApiKey() {
  try { return localStorage.getItem("bp-api-key") || ""; } catch(e) { return ""; }
}
function saveApiKey() {
  var key = document.getElementById("api-key").value.trim();
  try { localStorage.setItem("bp-api-key", key); } catch(e) {}
  updateApiStatus();
}
function updateApiStatus() {
  var el = document.getElementById("api-status");
  var scan = document.getElementById("scan-key-status");
  var key = getApiKey();
  if (key && key.startsWith("sk-")) {
    el.className = "api-status ok";
    el.textContent = "Key saved - camera ready";
    scan.innerHTML = '<span style="color:#3A7D5C;font-weight:600">Ready to scan</span>';
  } else {
    el.className = "api-status missing";
    el.textContent = key ? "Key should start with sk-ant-..." : "No key set";
    scan.innerHTML = '<span style="color:#D4873C">Set API key below to enable scanning</span>';
  }
}
function toggleSettings() {
  document.getElementById("settings-panel").classList.toggle("hidden");
}

function compressImage(dataUrl, maxWidth) {
  maxWidth = maxWidth || 800;
  return new Promise(function(resolve) {
    var img = new Image();
    img.onload = function() {
      var canvas = document.createElement("canvas");
      var w = img.width, h = img.height;
      if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
      canvas.width = w; canvas.height = h;
      canvas.getContext("2d").drawImage(img, 0, 0, w, h);
      resolve(canvas.toDataURL("image/jpeg", 0.6).split(",")[1]);
    };
    img.onerror = function() { resolve(null); };
    img.src = dataUrl;
  });
}

async function handlePhoto(input) {
  var file = input.files && input.files[0];
  if (!file) return;
  input.value = "";
  var apiKey = getApiKey();
  if (!apiKey || !apiKey.startsWith("sk-")) {
    showScanMsg("Set your API key first (scroll down)", "error");
    return;
  }
  showScanMsg("Compressing photo...", "scanning");
  showProgress(20);
  try {
    var dataUrl = await new Promise(function(resolve, reject) {
      var reader = new FileReader();
      reader.onload = function() { resolve(reader.result); };
      reader.onerror = function() { reject(new Error("Could not read file")); };
      reader.readAsDataURL(file);
    });
    showScanMsg("Sending to AI...", "scanning");
    showProgress(50);
    var base64 = await compressImage(dataUrl);
    if (!base64) { showScanMsg("Could not process image", "error"); return; }
    var res = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": apiKey,
        "anthropic-version": "2023-06-01",
        "anthropic-dangerous-direct-browser-access": "true"
      },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 300,
        messages: [{
          role: "user",
          content: [
            { type: "image", source: { type: "base64", media_type: "image/jpeg", data: base64 } },
            { type: "text", text: "This is a photo of a blood pressure monitor. Read the numbers on the screen. Return ONLY a JSON object: {\"systolic\":NUMBER,\"diastolic\":NUMBER,\"pulse\":NUMBER}. Use null for any value you cannot read. Return ONLY the JSON." }
          ]
        }]
      })
    });
    showProgress(80);
    if (!res.ok) {
      var errText = await res.text();
      showScanMsg("API error " + res.status + ": " + errText.slice(0, 150), "error");
      document.getElementById("progress").classList.add("hidden");
      return;
    }
    var data = await res.json();
    showProgress(100);
    var txt = data.content.map(function(b) { return b.text || ""; }).join("");
    var result = JSON.parse(txt.replace(/```json|```/g, "").trim());
    if (result.systolic != null) document.getElementById("systolic").value = result.systolic;
    if (result.diastolic != null) document.getElementById("diastolic").value = result.diastolic;
    if (result.pulse != null) document.getElementById("pulse").value = result.pulse;
    updatePreview();
    showScanMsg("Got it! Check the numbers and save.", "success");
  } catch (err) {
    showScanMsg("Error: " + (err.message || err), "error");
  }
  document.getElementById("progress").classList.add("hidden");
}

function renderHistory() {
  var sorted = readings.slice().sort(function(a, b) {
    return new Date(b.reading_datetime) - new Date(a.reading_datetime);
  });
  document.getElementById("total-count").textContent = sorted.length + " total";
  var list = document.getElementById("readings-list");
  if (sorted.length === 0) {
    list.innerHTML = '<div class="empty"><div class="empty-icon">&#128203;</div><div>No readings yet!</div></div>';
    return;
  }
  list.innerHTML = sorted.map(function(r) {
    var c = classify(r.systolic, r.diastolic);
    return '<div class="reading">' +
      '<div class="reading-top">' +
        '<span class="reading-date">' + fmtDate(r.reading_datetime) + ' &middot; ' + fmtTime(r.reading_datetime) + '</span>' +
        '<span class="badge" style="color:' + c.color + ';background:' + c.bg + '">' + c.label + '</span>' +
      '</div>' +
      '<div class="reading-vals">' +
        '<div><span class="reading-bp" style="color:' + c.color + '">' + r.systolic + '</span>' +
        '<span class="reading-slash"> / </span>' +
        '<span class="reading-bp" style="color:' + c.color + '">' + r.diastolic + '</span>' +
        '<span class="reading-unit">mmHg</span></div>' +
        (r.pulse ? '<div><span class="reading-pulse">' + r.pulse + '</span><span class="reading-unit">bpm</span></div>' : '') +
        '<button class="reading-del" onclick="deleteReading(' + r.id + ')">x</button>' +
      '</div>' +
      (r.notes ? '<div class="reading-notes">' + r.notes.replace(/</g, '&lt;') + '</div>' : '') +
    '</div>';
  }).join("");
}

async function deleteReading(id) {
  await deleteReadingDB(id);
  readings = readings.filter(function(r) { return r.id !== id; });
  renderHistory();
  setSyncStatus("Synced - " + readings.length + " readings", "#3A7D5C");
}

var bpChart = null, pulseChart = null;
function renderCharts() {
  var sorted = readings.slice().sort(function(a, b) {
    return new Date(a.reading_datetime) - new Date(b.reading_datetime);
  });
  if (sorted.length < 2) {
    document.getElementById("charts-empty").classList.remove("hidden");
    document.getElementById("charts-content").classList.add("hidden");
    return;
  }
  document.getElementById("charts-empty").classList.add("hidden");
  document.getElementById("charts-content").classList.remove("hidden");
  var labels = sorted.map(function(r) { return fmtShort(r.reading_datetime); });
  var sysData = sorted.map(function(r) { return +r.systolic; });
  var diaData = sorted.map(function(r) { return +r.diastolic; });
  var pulseData = sorted.map(function(r) { return r.pulse ? +r.pulse : null; });
  if (bpChart) bpChart.destroy();
  if (pulseChart) pulseChart.destroy();
  var opts = {
    responsive: true,
    plugins: { legend: { labels: { font: { size: 12 } } } },
    scales: {
      x: { ticks: { font: { size: 11 }, color: "#8A8778" } },
      y: { ticks: { font: { size: 11 }, color: "#8A8778" } }
    }
  };
  bpChart = new Chart(document.getElementById("bp-chart"), {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        { label: "Systolic", data: sysData, borderColor: "#D4573B", backgroundColor: "#D4573B33", borderWidth: 2.5, pointRadius: 4, tension: 0.3 },
        { label: "Diastolic", data: diaData, borderColor: "#3A7D5C", backgroundColor: "#3A7D5C33", borderWidth: 2.5, pointRadius: 4, tension: 0.3 }
      ]
    },
    options: opts
  });
  pulseChart = new Chart(document.getElementById("pulse-chart"), {
    type: "line",
    data: {
      labels: labels,
      datasets: [{ label: "Pulse", data: pulseData, borderColor: "#D4A03C", backgroundColor: "#D4A03C33", borderWidth: 2.5, pointRadius: 4, tension: 0.3, spanGaps: true }]
    },
    options: opts
  });
}

// Init
document.getElementById("datetime").value = localNow();
document.getElementById("api-key").value = getApiKey();
updateApiStatus();
if (!getApiKey()) document.getElementById("settings-panel").classList.remove("hidden");
loadReadings().then(renderHistory);
</script>
</body>
</html>
