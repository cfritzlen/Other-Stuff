<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="BP Tracker">
<title>BP Tracker</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, 'Avenir', 'Nunito', 'Segoe UI', sans-serif;
    background: #F0EDE6; color: #1A1A1A;
    max-width: 480px; margin: 0 auto; padding: 0 16px 60px;
    min-height: 100vh; -webkit-font-smoothing: antialiased;
  }
  .header { text-align: center; padding: 28px 0 12px; }
  .header h1 { font-size: 24px; font-weight: 700; color: #2D5F46; }
  .header p { font-size: 13px; color: #8A8778; margin-top: 4px; }
  .sync-status { text-align: center; font-size: 11px; padding: 4px 0 8px; font-weight: 600; }
  .tabs { display: flex; border-bottom: 2px solid #EAE7E0; margin-bottom: 16px; }
  .tab {
    flex: 1; padding: 10px 0; border: none; background: none;
    font-size: 14px; font-weight: 600; cursor: pointer;
    font-family: inherit; border-bottom: 2.5px solid transparent;
    color: #8A8778; transition: all 0.2s;
  }
  .tab.active { color: #3A7D5C; border-bottom-color: #3A7D5C; }
  .card {
    background: #FFF; border-radius: 16px; padding: 20px;
    margin-bottom: 14px; border: 1px solid #EAE7E0;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  }
  .sec-title {
    font-size: 13px; font-weight: 700; color: #2D5F46;
    text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 14px;
  }
  .scan-area {
    border: 2px dashed #DDD9CF; border-radius: 12px;
    padding: 24px 16px; text-align: center; cursor: pointer;
    background: #FAFAF7; transition: all 0.2s;
  }
  .scan-area:active { background: #D4E8DB; border-color: #3A7D5C; }
  .scan-icon { font-size: 32px; margin-bottom: 6px; }
  .scan-title { font-size: 15px; font-weight: 600; color: #2D5F46; }
  .scan-sub { font-size: 12px; color: #8A8778; margin-top: 4px; }
  .scan-msg {
    margin-top: 10px; padding: 8px 12px; border-radius: 8px;
    font-size: 13px; font-weight: 600; word-break: break-word;
  }
  .scan-msg.success { background: #D4E8DB; color: #3A7D5C; }
  .scan-msg.error { background: #FFF3E0; color: #D4873C; }
  .scan-msg.scanning { background: #D4E8DB; color: #3A7D5C; }
  .row { display: flex; gap: 10px; margin-bottom: 12px; }
  .field { flex: 1; }
  .label {
    display: block; font-size: 11px; font-weight: 700; color: #8A8778;
    text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 5px;
  }
  input, textarea {
    width: 100%; padding: 10px 12px; border-radius: 8px;
    border: 1.5px solid #DDD9CF; font-size: 16px; font-family: inherit;
    color: #1A1A1A; background: #FFF; outline: none;
  }
  input:focus, textarea:focus { border-color: #3A7D5C; }
  textarea { font-size: 14px; resize: vertical; min-height: 56px; }
  .preview {
    padding: 8px 14px; border-radius: 10px; margin-bottom: 12px;
    display: flex; align-items: center; gap: 8px;
  }
  .preview-num { font-size: 22px; font-weight: 700; }
  .badge {
    display: inline-block; padding: 2px 10px; border-radius: 20px;
    font-size: 11px; font-weight: 700;
  }
  .btns { display: flex; gap: 10px; }
  .btn {
    display: inline-flex; align-items: center; justify-content: center;
    padding: 12px 24px; border-radius: 10px; border: none;
    font-weight: 600; font-size: 15px; cursor: pointer; font-family: inherit;
  }
  .btn-pri { background: #3A7D5C; color: #FFF; flex: 1; }
  .btn-pri:disabled { opacity: 0.4; cursor: default; }
  .btn-out { background: transparent; color: #3A7D5C; border: 1.5px solid #3A7D5C; }
  .reading {
    padding: 14px 16px; border-radius: 12px; background: #FAFAF7;
    border: 1px solid #EAE7E0; margin-bottom: 10px;
  }
  .reading-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
  .reading-date { font-size: 12px; color: #8A8778; font-weight: 600; }
  .reading-vals { display: flex; gap: 16px; align-items: baseline; }
  .reading-bp { font-size: 26px; font-weight: 700; }
  .reading-slash { font-size: 14px; color: #8A8778; }
  .reading-unit { font-size: 12px; color: #8A8778; margin-left: 4px; }
  .reading-pulse { font-size: 20px; font-weight: 700; color: #D4A03C; }
  .reading-del {
    margin-left: auto; background: none; border: none;
    cursor: pointer; color: #8A8778; font-size: 18px; padding: 4px;
  }
  .reading-notes {
    font-size: 13px; color: #555549; line-height: 1.4;
    border-top: 1px solid #EAE7E0; padding-top: 8px; margin-top: 8px;
  }
  .empty { text-align: center; padding: 30px 0; color: #8A8778; }
  .empty-icon { font-size: 36px; margin-bottom: 8px; }
  .chart-wrap { margin-bottom: 24px; }
  .chart-label {
    font-size: 12px; font-weight: 700; color: #8A8778;
    text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 10px;
  }
  .footer {
    text-align: center; padding: 16px 0; font-size: 11px;
    color: #8A8778; line-height: 1.6;
  }
  .settings-toggle { text-align: center; margin-bottom: 10px; }
  .settings-toggle button {
    background: none; border: none; color: #8A8778; font-size: 13px;
    cursor: pointer; font-family: inherit; text-decoration: underline;
  }
  .api-key-input {
    width: 100%; padding: 10px 12px; border-radius: 8px;
    border: 1.5px solid #DDD9CF; font-size: 14px; font-family: monospace;
    color: #1A1A1A; background: #FFF; outline: none;
  }
  .api-key-input:focus { border-color: #3A7D5C; }
  .api-status {
    margin-top: 8px; font-size: 12px; font-weight: 600;
    padding: 6px 10px; border-radius: 6px;
  }
  .api-status.ok { background: #D4E8DB; color: #3A7D5C; }
  .api-status.missing { background: #FFF3E0; color: #D4873C; }
  .progress-bar {
    height: 4px; background: #EAE7E0; border-radius: 2px;
    margin-top: 10px; overflow: hidden;
  }
  .stat-section { margin-bottom: 18px; }
  .stat-section:last-child { margin-bottom: 0; }
  .stat-label {
    font-size: 11px; font-weight: 700; color: #8A8778;
    text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 8px;
  }
  .stat-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 8px 12px; border-radius: 8px; margin-bottom: 4px;
    background: #FAFAF7;
  }
  .stat-name { font-size: 13px; color: #555549; }
  .stat-val { font-size: 15px; font-weight: 700; }
  .stat-sub { font-size: 11px; color: #8A8778; margin-left: 4px; font-weight: 400; }
  .cat-bar-wrap { margin-bottom: 6px; }
  .cat-bar-label {
    display: flex; justify-content: space-between; font-size: 12px;
    margin-bottom: 3px; font-weight: 600;
  }
  .cat-bar {
    height: 8px; border-radius: 4px; background: #EAE7E0; overflow: hidden;
  }
  .cat-bar-fill {
    height: 100%; border-radius: 4px; transition: width 0.4s;
  }
  .stat-divider {
    height: 1px; background: #EAE7E0; margin: 14px 0;
  }
  .progress-fill {
    height: 100%; background: #3A7D5C; border-radius: 2px;
    transition: width 0.3s;
  }
  .hidden { display: none; }
  .sleep-entry {
    padding: 14px 16px; border-radius: 12px; background: #FAFAF7;
    border: 1px solid #EAE7E0; margin-bottom: 10px;
  }
  .sleep-date { font-size: 12px; color: #8A8778; font-weight: 600; margin-bottom: 6px; }
  .sleep-total { font-size: 24px; font-weight: 700; color: #2D5F46; }
  .sleep-stages { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
  .sleep-stage {
    font-size: 11px; padding: 3px 8px; border-radius: 6px; font-weight: 600;
  }
  .stage-awake { background: #FDEEEE; color: #D4573B; }
  .stage-rem { background: #E0F5F5; color: #0EA5A5; }
  .stage-core { background: #DDEEFF; color: #3A7DC0; }
  .stage-deep { background: #E8E0F5; color: #6B4FA0; }
  #file-input, #sleep-file-input { display: none; }
</style>
</head>
<body>

<div class="header">
  <h1>&#9829; BP Tracker</h1>
  <p>Snap &middot; Log &middot; Track</p>
</div>
<div id="sync-status" class="sync-status" style="color:#8A8778">Loading...</div>

<div class="tabs">
  <button class="tab active" onclick="showTab('add')">&#xFF0B; New</button>
  <button class="tab" onclick="showTab('history')">History</button>
  <button class="tab" onclick="showTab('sleep')">Sleep</button>
  <button class="tab" onclick="showTab('charts')">Charts</button>
</div>

<div id="tab-add">
  <div class="card">
    <div class="sec-title">&#128247; Scan Monitor</div>
    <div class="scan-area" onclick="document.getElementById('file-input').click()">
      <div class="scan-icon">&#128248;</div>
      <div class="scan-title">Tap to take a photo</div>
      <div class="scan-sub">Point at your BP monitor screen</div>
    </div>
    <div id="scan-key-status" style="margin-top:8px;font-size:12px;text-align:center"></div>
    <input type="file" id="file-input" accept="image/*" capture="environment" onchange="handlePhoto(this)">
    <div id="scan-msg" class="scan-msg hidden"></div>
    <div id="progress" class="progress-bar hidden"><div id="progress-fill" class="progress-fill" style="width:0%"></div></div>
  </div>

  <div class="card">
    <div class="sec-title">Readings</div>
    <div class="row">
      <div class="field">
        <label class="label">Systolic</label>
        <input type="number" inputmode="numeric" id="systolic" placeholder="120" oninput="updatePreview()">
      </div>
      <div class="field">
        <label class="label">Diastolic</label>
        <input type="number" inputmode="numeric" id="diastolic" placeholder="80" oninput="updatePreview()">
      </div>
      <div class="field">
        <label class="label">Pulse</label>
        <input type="number" inputmode="numeric" id="pulse" placeholder="72">
      </div>
    </div>
    <div id="preview" class="preview hidden">
      <span id="preview-num" class="preview-num"></span>
      <span id="preview-badge" class="badge"></span>
    </div>
    <div style="margin-bottom:12px">
      <label class="label">Date &amp; Time</label>
      <input type="datetime-local" id="datetime">
    </div>
    <div style="margin-bottom:16px">
      <label class="label">Notes (optional)</label>
      <textarea id="notes" placeholder="e.g. after coffee, felt dizzy, took meds..." rows="2"></textarea>
    </div>
    <div class="btns">
      <button class="btn btn-pri" id="save-btn" disabled onclick="saveReading()">Save Reading</button>
      <button class="btn btn-out" onclick="clearForm()">Clear</button>
    </div>
  </div>
</div>

<div id="tab-history" class="hidden">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div class="sec-title">All Readings</div>
      <span id="total-count" style="font-size:12px;color:#8A8778"></span>
    </div>
    <div id="readings-list"></div>
  </div>
</div>

<div id="tab-sleep" class="hidden">
  <div class="card">
    <div class="sec-title">&#128247; Scan Sleep Data</div>
    <div class="scan-area" onclick="document.getElementById('sleep-file-input').click()">
      <div class="scan-icon">&#127769;</div>
      <div class="scan-title">Screenshot your Health app</div>
      <div class="scan-sub">Health &rarr; Sleep &rarr; Stages view</div>
    </div>
    <input type="file" id="sleep-file-input" accept="image/*" style="display:none" onchange="handleSleepPhoto(this)">
    <div id="sleep-scan-msg" class="scan-msg hidden"></div>
    <div id="sleep-progress" class="progress-bar hidden"><div id="sleep-progress-fill" class="progress-fill" style="width:0%"></div></div>
  </div>

  <div class="card">
    <div class="sec-title">Sleep Entry</div>
    <div style="margin-bottom:12px">
      <label class="label">Date</label>
      <input type="date" id="sleep-date">
    </div>
    <div class="row">
      <div class="field">
        <label class="label">Total Asleep</label>
        <div class="row" style="margin-bottom:0">
          <div class="field"><input type="number" inputmode="numeric" id="sleep-hrs" placeholder="8" style="text-align:center"><div style="font-size:10px;color:#8A8778;text-align:center;margin-top:2px">hrs</div></div>
          <div class="field"><input type="number" inputmode="numeric" id="sleep-min" placeholder="36" style="text-align:center"><div style="font-size:10px;color:#8A8778;text-align:center;margin-top:2px">min</div></div>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label class="label">Awake</label>
        <input type="number" inputmode="numeric" id="sleep-awake" placeholder="57 min">
      </div>
      <div class="field">
        <label class="label">REM</label>
        <input type="number" inputmode="numeric" id="sleep-rem" placeholder="162 min">
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label class="label">Core</label>
        <input type="number" inputmode="numeric" id="sleep-core" placeholder="295 min">
      </div>
      <div class="field">
        <label class="label">Deep</label>
        <input type="number" inputmode="numeric" id="sleep-deep" placeholder="59 min">
      </div>
    </div>
    <div class="row">
      <div class="field">
        <label class="label">Bedtime</label>
        <input type="text" id="sleep-bedtime" placeholder="e.g. 9:30 PM">
      </div>
      <div class="field">
        <label class="label">Wake Time</label>
        <input type="text" id="sleep-waketime" placeholder="e.g. 6:00 AM">
      </div>
    </div>
    <div style="margin-bottom:16px">
      <label class="label">Notes (optional)</label>
      <textarea id="sleep-notes" placeholder="e.g. restless, snoring, woke up at 3am..." rows="2"></textarea>
    </div>
    <div class="btns">
      <button class="btn btn-pri" id="sleep-save-btn" onclick="saveSleep()">Save Sleep</button>
      <button class="btn btn-out" onclick="clearSleepForm()">Clear</button>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div class="sec-title">Sleep History</div>
      <span id="sleep-total" style="font-size:12px;color:#8A8778"></span>
    </div>
    <div id="sleep-list"></div>
  </div>
</div>

<div id="tab-charts" class="hidden">
  <div class="card" id="stats-card" style="display:none">
    <div class="sec-title">Summary</div>
    <div id="stats-content"></div>
  </div>
  <div class="card">
    <div class="sec-title">Trends</div>
    <div id="charts-empty" class="empty">Need at least 2 readings for charts</div>
    <div id="charts-content" class="hidden">
      <div class="chart-wrap">
        <div class="chart-label">Blood Pressure</div>
        <canvas id="bp-chart"></canvas>
      </div>
      <div class="chart-wrap">
        <div class="chart-label">Pulse</div>
        <canvas id="pulse-chart"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="footer">
  Normal: &lt;120/80 &middot; Elevated: 120-129/&lt;80<br>
  High Stage 1: 130-139/80-89 &middot; Stage 2: &ge;140/&ge;90
</div>

<div class="settings-toggle">
  <button onclick="toggleSettings()">&#9881;&#65039; API Key Settings</button>
</div>

<div id="settings-panel" class="card hidden">
  <div class="sec-title">&#128273; Claude API Key</div>
  <p style="font-size:13px;color:#555549;margin-bottom:10px;line-height:1.4">
    Needed for camera scanning. Get one at
    <a href="https://console.anthropic.com/settings/keys" target="_blank" style="color:#3A7D5C">console.anthropic.com</a>
  </p>
  <input type="password" class="api-key-input" id="api-key" placeholder="sk-ant-..." oninput="saveApiKey()">
  <div id="api-status"></div>
  <div style="margin-top:8px;font-size:11px;color:#8A8778;line-height:1.4">
    Your key is stored only on this device.<br>
    Do NOT use Private/Incognito mode or the key will be erased.
  </div>
</div>

<script>
var SUPA_URL = "https://jzpipxvxrtdhmsdkveog.supabase.co";
var SUPA_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp6cGlweHZ4cnRkaG1zZGt2ZW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTE1MjUsImV4cCI6MjA4NTMyNzUyNX0.7mm0ts91y0leGKLFCgRk6KJitah3V5WJZdiD_gHL57o";
var SUPA_HEADERS = {
  "apikey": SUPA_KEY,
  "Authorization": "Bearer " + SUPA_KEY,
  "Content-Type": "application/json",
  "Prefer": "return=representation"
};

var readings = [];

async function fetchReadings() {
  try {
    var res = await fetch(SUPA_URL + "/rest/v1/bp_readings?order=reading_datetime.desc", { headers: SUPA_HEADERS });
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  } catch (e) {
    setSyncStatus("Offline - could not load", "#D4873C");
    return [];
  }
}

async function insertReading(entry) {
  try {
    var res = await fetch(SUPA_URL + "/rest/v1/bp_readings", {
      method: "POST", headers: SUPA_HEADERS, body: JSON.stringify(entry)
    });
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  } catch (e) {
    setSyncStatus("Could not save: " + e.message, "#D4873C");
    return null;
  }
}

async function deleteReadingDB(id) {
  try {
    await fetch(SUPA_URL + "/rest/v1/bp_readings?id=eq." + id, {
      method: "DELETE", headers: SUPA_HEADERS
    });
  } catch (e) { console.error(e); }
}

function setSyncStatus(text, color) {
  var el = document.getElementById("sync-status");
  el.textContent = text;
  el.style.color = color || "#8A8778";
}

async function loadReadings() {
  setSyncStatus("Syncing...", "#8A8778");
  readings = await fetchReadings();
  setSyncStatus("Synced - " + readings.length + " readings", "#3A7D5C");
}

function classify(sys, dia) {
  var s = +sys, d = +dia;
  if (!s || !d) return { label: "-", color: "#8A8778", bg: "#8A877818" };
  if (s < 120 && d < 80) return { label: "Normal", color: "#3A7D5C", bg: "#3A7D5C18" };
  if (s < 130 && d < 80) return { label: "Elevated", color: "#D4873C", bg: "#D4873C18" };
  if (s < 140 || d < 90) return { label: "High - Stage 1", color: "#D4573B", bg: "#D4573B18" };
  return { label: "High - Stage 2", color: "#C42B2B", bg: "#C42B2B18" };
}

function fmtDate(iso) { return new Date(iso).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" }); }
function fmtTime(iso) { return new Date(iso).toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit" }); }
function fmtShort(iso) { return new Date(iso).toLocaleDateString("en-US", { month: "short", day: "numeric" }); }
function localNow() {
  var n = new Date();
  return new Date(n.getTime() - n.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
}

function showTab(name) {
  document.querySelectorAll(".tab").forEach(function(t, i) {
    t.classList.toggle("active", ["add","history","sleep","charts"][i] === name);
  });
  ["add","history","sleep","charts"].forEach(function(t) {
    document.getElementById("tab-" + t).classList.toggle("hidden", t !== name);
  });
  if (name === "history") { loadReadings().then(renderHistory); }
  if (name === "sleep") { loadSleepEntries().then(renderSleepHistory); }
  if (name === "charts") { loadReadings().then(function() { loadSleepEntries().then(function() { renderStats(); renderCharts(); }); }); }
}

function updatePreview() {
  var sys = document.getElementById("systolic").value;
  var dia = document.getElementById("diastolic").value;
  var preview = document.getElementById("preview");
  var btn = document.getElementById("save-btn");
  if (sys && dia) {
    var c = classify(sys, dia);
    document.getElementById("preview-num").textContent = sys + "/" + dia;
    document.getElementById("preview-num").style.color = c.color;
    document.getElementById("preview-badge").textContent = c.label;
    document.getElementById("preview-badge").style.color = c.color;
    document.getElementById("preview-badge").style.background = c.bg;
    preview.style.background = c.bg;
    preview.style.border = "1px solid " + c.color + "30";
    preview.classList.remove("hidden");
    btn.disabled = false;
  } else {
    preview.classList.add("hidden");
    btn.disabled = true;
  }
}

function clearForm() {
  document.getElementById("systolic").value = "";
  document.getElementById("diastolic").value = "";
  document.getElementById("pulse").value = "";
  document.getElementById("datetime").value = localNow();
  document.getElementById("notes").value = "";
  document.getElementById("scan-msg").classList.add("hidden");
  document.getElementById("progress").classList.add("hidden");
  updatePreview();
}

async function saveReading() {
  var sys = document.getElementById("systolic").value;
  var dia = document.getElementById("diastolic").value;
  if (!sys || !dia) return;
  var btn = document.getElementById("save-btn");
  btn.disabled = true;
  btn.textContent = "Saving...";
  var dt = document.getElementById("datetime").value;
  var entry = {
    systolic: parseInt(sys),
    diastolic: parseInt(dia),
    pulse: document.getElementById("pulse").value ? parseInt(document.getElementById("pulse").value) : null,
    reading_datetime: new Date(dt).toISOString(),
    notes: document.getElementById("notes").value || null
  };
  var result = await insertReading(entry);
  if (result) {
    await loadReadings();
    clearForm();
    showTab("history");
  }
  btn.disabled = false;
  btn.textContent = "Save Reading";
}

function showScanMsg(text, type) {
  var el = document.getElementById("scan-msg");
  el.textContent = text;
  el.className = "scan-msg " + type;
  el.classList.remove("hidden");
}

function showProgress(pct) {
  var bar = document.getElementById("progress");
  bar.classList.remove("hidden");
  document.getElementById("progress-fill").style.width = pct + "%";
}

function getApiKey() {
  try { return localStorage.getItem("bp-api-key") || ""; } catch(e) { return ""; }
}
function saveApiKey() {
  var key = document.getElementById("api-key").value.trim();
  try { localStorage.setItem("bp-api-key", key); } catch(e) {}
  updateApiStatus();
}
function updateApiStatus() {
  var el = document.getElementById("api-status");
  var scan = document.getElementById("scan-key-status");
  var key = getApiKey();
  if (key && key.startsWith("sk-")) {
    el.className = "api-status ok";
    el.textContent = "Key saved - camera ready";
    scan.innerHTML = '<span style="color:#3A7D5C;font-weight:600">Ready to scan</span>';
  } else {
    el.className = "api-status missing";
    el.textContent = key ? "Key should start with sk-ant-..." : "No key set";
    scan.innerHTML = '<span style="color:#D4873C">Set API key below to enable scanning</span>';
  }
}
function toggleSettings() {
  document.getElementById("settings-panel").classList.toggle("hidden");
}

function compressImage(dataUrl, maxWidth) {
  maxWidth = maxWidth || 800;
  return new Promise(function(resolve) {
    var img = new Image();
    img.onload = function() {
      var canvas = document.createElement("canvas");
      var w = img.width, h = img.height;
      if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
      canvas.width = w; canvas.height = h;
      canvas.getContext("2d").drawImage(img, 0, 0, w, h);
      resolve(canvas.toDataURL("image/jpeg", 0.6).split(",")[1]);
    };
    img.onerror = function() { resolve(null); };
    img.src = dataUrl;
  });
}

async function handlePhoto(input) {
  var file = input.files && input.files[0];
  if (!file) return;
  input.value = "";
  var apiKey = getApiKey();
  if (!apiKey || !apiKey.startsWith("sk-")) {
    showScanMsg("Set your API key first (scroll down)", "error");
    return;
  }
  showScanMsg("Compressing photo...", "scanning");
  showProgress(20);
  try {
    var dataUrl = await new Promise(function(resolve, reject) {
      var reader = new FileReader();
      reader.onload = function() { resolve(reader.result); };
      reader.onerror = function() { reject(new Error("Could not read file")); };
      reader.readAsDataURL(file);
    });
    showScanMsg("Sending to AI...", "scanning");
    showProgress(50);
    var base64 = await compressImage(dataUrl);
    if (!base64) { showScanMsg("Could not process image", "error"); return; }
    var res = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": apiKey,
        "anthropic-version": "2023-06-01",
        "anthropic-dangerous-direct-browser-access": "true"
      },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 300,
        messages: [{
          role: "user",
          content: [
            { type: "image", source: { type: "base64", media_type: "image/jpeg", data: base64 } },
            { type: "text", text: "This is a photo of a blood pressure monitor. Read the numbers on the screen. Return ONLY a JSON object: {\"systolic\":NUMBER,\"diastolic\":NUMBER,\"pulse\":NUMBER}. Use null for any value you cannot read. Return ONLY the JSON." }
          ]
        }]
      })
    });
    showProgress(80);
    if (!res.ok) {
      var errText = await res.text();
      showScanMsg("API error " + res.status + ": " + errText.slice(0, 150), "error");
      document.getElementById("progress").classList.add("hidden");
      return;
    }
    var data = await res.json();
    showProgress(100);
    var txt = data.content.map(function(b) { return b.text || ""; }).join("");
    var result = JSON.parse(txt.replace(/```json|```/g, "").trim());
    if (result.systolic != null) document.getElementById("systolic").value = result.systolic;
    if (result.diastolic != null) document.getElementById("diastolic").value = result.diastolic;
    if (result.pulse != null) document.getElementById("pulse").value = result.pulse;
    updatePreview();
    showScanMsg("Got it! Check the numbers and save.", "success");
  } catch (err) {
    showScanMsg("Error: " + (err.message || err), "error");
  }
  document.getElementById("progress").classList.add("hidden");
}

function renderHistory() {
  var sorted = readings.slice().sort(function(a, b) {
    return new Date(b.reading_datetime) - new Date(a.reading_datetime);
  });
  document.getElementById("total-count").textContent = sorted.length + " total";
  var list = document.getElementById("readings-list");
  if (sorted.length === 0) {
    list.innerHTML = '<div class="empty"><div class="empty-icon">&#128203;</div><div>No readings yet!</div></div>';
    return;
  }
  list.innerHTML = sorted.map(function(r) {
    var c = classify(r.systolic, r.diastolic);
    return '<div class="reading">' +
      '<div class="reading-top">' +
        '<span class="reading-date">' + fmtDate(r.reading_datetime) + ' &middot; ' + fmtTime(r.reading_datetime) + '</span>' +
        '<span class="badge" style="color:' + c.color + ';background:' + c.bg + '">' + c.label + '</span>' +
      '</div>' +
      '<div class="reading-vals">' +
        '<div><span class="reading-bp" style="color:' + c.color + '">' + r.systolic + '</span>' +
        '<span class="reading-slash"> / </span>' +
        '<span class="reading-bp" style="color:' + c.color + '">' + r.diastolic + '</span>' +
        '<span class="reading-unit">mmHg</span></div>' +
        (r.pulse ? '<div><span class="reading-pulse">' + r.pulse + '</span><span class="reading-unit">bpm</span></div>' : '') +
        '<button class="reading-del" onclick="deleteReading(' + r.id + ')">x</button>' +
      '</div>' +
      (r.notes ? '<div class="reading-notes">' + r.notes.replace(/</g, '&lt;') + '</div>' : '') +
    '</div>';
  }).join("");
}

async function deleteReading(id) {
  await deleteReadingDB(id);
  readings = readings.filter(function(r) { return r.id !== id; });
  renderHistory();
  setSyncStatus("Synced - " + readings.length + " readings", "#3A7D5C");
}

var bpChart = null, pulseChart = null;

function renderStats() {
  if (readings.length === 0) {
    document.getElementById("stats-card").style.display = "none";
    return;
  }
  document.getElementById("stats-card").style.display = "";
  var now = new Date();
  var d7 = new Date(now - 7 * 86400000);
  var d30 = new Date(now - 30 * 86400000);
  var r7 = readings.filter(function(r) { return new Date(r.reading_datetime) >= d7; });
  var r30 = readings.filter(function(r) { return new Date(r.reading_datetime) >= d30; });
  var all = readings;

  function avg(arr, key) {
    if (!arr.length) return "--";
    var sum = arr.reduce(function(s, r) { return s + (+r[key]); }, 0);
    return Math.round(sum / arr.length);
  }
  function avgPulse(arr) {
    var p = arr.filter(function(r) { return r.pulse; });
    if (!p.length) return "--";
    return avg(p, "pulse");
  }

  // Morning (5am-12pm) vs Evening (5pm-10pm)
  var morning = all.filter(function(r) {
    var h = new Date(r.reading_datetime).getHours();
    return h >= 5 && h < 12;
  });
  var evening = all.filter(function(r) {
    var h = new Date(r.reading_datetime).getHours();
    return h >= 17 && h < 22;
  });

  // Categories
  var cats = { normal: 0, elevated: 0, high1: 0, high2: 0 };
  all.forEach(function(r) {
    var c = classify(r.systolic, r.diastolic);
    if (c.label.indexOf("Normal") >= 0) cats.normal++;
    else if (c.label.indexOf("Elevated") >= 0) cats.elevated++;
    else if (c.label.indexOf("Stage 1") >= 0) cats.high1++;
    else if (c.label.indexOf("Stage 2") >= 0) cats.high2++;
  });
  var total = all.length;
  function pct(n) { return total ? Math.round(n / total * 100) : 0; }

  // Highest & Lowest
  var sorted = all.slice().sort(function(a, b) { return (+b.systolic) - (+a.systolic); });
  var highest = sorted[0];
  var lowest = sorted[sorted.length - 1];

  var html = '';

  // 7-day & 30-day averages
  html += '<div class="stat-section">';
  html += '<div class="stat-label">Averages</div>';
  if (r7.length > 0) {
    html += '<div class="stat-row"><span class="stat-name">Last 7 days <span class="stat-sub">(' + r7.length + ' readings)</span></span>';
    html += '<span class="stat-val" style="color:' + classify(avg(r7,"systolic"), avg(r7,"diastolic")).color + '">' + avg(r7,"systolic") + '/' + avg(r7,"diastolic") + '</span></div>';
  }
  if (r30.length > 0) {
    html += '<div class="stat-row"><span class="stat-name">Last 30 days <span class="stat-sub">(' + r30.length + ' readings)</span></span>';
    html += '<span class="stat-val" style="color:' + classify(avg(r30,"systolic"), avg(r30,"diastolic")).color + '">' + avg(r30,"systolic") + '/' + avg(r30,"diastolic") + '</span></div>';
  }
  if (r7.length === 0 && r30.length === 0) {
    html += '<div class="stat-row"><span class="stat-name">All time <span class="stat-sub">(' + all.length + ' readings)</span></span>';
    html += '<span class="stat-val" style="color:' + classify(avg(all,"systolic"), avg(all,"diastolic")).color + '">' + avg(all,"systolic") + '/' + avg(all,"diastolic") + '</span></div>';
  }
  html += '</div>';

  // Morning vs Evening
  html += '<div class="stat-divider"></div>';
  html += '<div class="stat-section">';
  html += '<div class="stat-label">Morning vs Evening</div>';
  if (morning.length > 0) {
    html += '<div class="stat-row"><span class="stat-name">Morning <span class="stat-sub">(5am–12pm · ' + morning.length + ')</span></span>';
    html += '<span class="stat-val" style="color:' + classify(avg(morning,"systolic"), avg(morning,"diastolic")).color + '">' + avg(morning,"systolic") + '/' + avg(morning,"diastolic");
    html += ' <span class="stat-sub">' + avgPulse(morning) + ' bpm</span></span></div>';
  } else {
    html += '<div class="stat-row"><span class="stat-name">Morning</span><span class="stat-val" style="color:#8A8778">No data</span></div>';
  }
  if (evening.length > 0) {
    html += '<div class="stat-row"><span class="stat-name">Evening <span class="stat-sub">(5pm–10pm · ' + evening.length + ')</span></span>';
    html += '<span class="stat-val" style="color:' + classify(avg(evening,"systolic"), avg(evening,"diastolic")).color + '">' + avg(evening,"systolic") + '/' + avg(evening,"diastolic");
    html += ' <span class="stat-sub">' + avgPulse(evening) + ' bpm</span></span></div>';
  } else {
    html += '<div class="stat-row"><span class="stat-name">Evening</span><span class="stat-val" style="color:#8A8778">No data</span></div>';
  }
  html += '</div>';

  // Category breakdown
  html += '<div class="stat-divider"></div>';
  html += '<div class="stat-section">';
  html += '<div class="stat-label">Reading Breakdown</div>';
  var catData = [
    { name: "Normal", pct: pct(cats.normal), color: "#3A7D5C", n: cats.normal },
    { name: "Elevated", pct: pct(cats.elevated), color: "#D4873C", n: cats.elevated },
    { name: "High - Stage 1", pct: pct(cats.high1), color: "#D4573B", n: cats.high1 },
    { name: "High - Stage 2", pct: pct(cats.high2), color: "#C42B2B", n: cats.high2 }
  ];
  catData.forEach(function(c) {
    html += '<div class="cat-bar-wrap">';
    html += '<div class="cat-bar-label"><span style="color:' + c.color + '">' + c.name + '</span><span style="color:' + c.color + '">' + c.pct + '% <span class="stat-sub">(' + c.n + ')</span></span></div>';
    html += '<div class="cat-bar"><div class="cat-bar-fill" style="width:' + c.pct + '%;background:' + c.color + '"></div></div>';
    html += '</div>';
  });
  html += '</div>';

  // Highest & Lowest
  html += '<div class="stat-divider"></div>';
  html += '<div class="stat-section">';
  html += '<div class="stat-label">Highest &amp; Lowest</div>';
  var hc = classify(highest.systolic, highest.diastolic);
  html += '<div class="stat-row"><span class="stat-name">Highest <span class="stat-sub">' + fmtDate(highest.reading_datetime) + '</span></span>';
  html += '<span class="stat-val" style="color:' + hc.color + '">' + highest.systolic + '/' + highest.diastolic + '</span></div>';
  var lc = classify(lowest.systolic, lowest.diastolic);
  html += '<div class="stat-row"><span class="stat-name">Lowest <span class="stat-sub">' + fmtDate(lowest.reading_datetime) + '</span></span>';
  html += '<span class="stat-val" style="color:' + lc.color + '">' + lowest.systolic + '/' + lowest.diastolic + '</span></div>';
  html += '</div>';

  document.getElementById("stats-content").innerHTML = html;

  // Sleep stats
  if (sleepEntries.length > 0) {
    var sh = '';
    sh += '<div class="stat-divider"></div>';
    sh += '<div class="stat-section">';
    sh += '<div class="stat-label">&#127769; Sleep Averages</div>';
    var s7 = sleepEntries.filter(function(s) { return new Date(s.sleep_date) >= d7; });
    var s30 = sleepEntries.filter(function(s) { return new Date(s.sleep_date) >= d30; });
    var sAll = sleepEntries;
    function sleepAvg(arr) {
      if (!arr.length) return "--";
      var sum = arr.reduce(function(s, e) { return s + (e.total_asleep_minutes || 0); }, 0);
      return fmtMins(Math.round(sum / arr.length));
    }
    function stageAvg(arr, key) {
      var valid = arr.filter(function(e) { return e[key]; });
      if (!valid.length) return "--";
      var sum = valid.reduce(function(s, e) { return s + e[key]; }, 0);
      return fmtMins(Math.round(sum / valid.length));
    }
    var sleepSrc = s7.length >= 2 ? s7 : (s30.length >= 2 ? s30 : sAll);
    var sleepLabel = s7.length >= 2 ? "Last 7 days" : (s30.length >= 2 ? "Last 30 days" : "All time");
    sh += '<div class="stat-row"><span class="stat-name">' + sleepLabel + ' avg <span class="stat-sub">(' + sleepSrc.length + ' nights)</span></span>';
    sh += '<span class="stat-val" style="color:#2D5F46">' + sleepAvg(sleepSrc) + '</span></div>';
    sh += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px">';
    sh += '<span class="sleep-stage stage-rem">REM ' + stageAvg(sleepSrc, "rem_minutes") + '</span>';
    sh += '<span class="sleep-stage stage-core">Core ' + stageAvg(sleepSrc, "core_minutes") + '</span>';
    sh += '<span class="sleep-stage stage-deep">Deep ' + stageAvg(sleepSrc, "deep_minutes") + '</span>';
    sh += '<span class="sleep-stage stage-awake">Awake ' + stageAvg(sleepSrc, "awake_minutes") + '</span>';
    sh += '</div>';
    sh += '</div>';
    document.getElementById("stats-content").innerHTML += sh;
  }
}

function renderCharts() {
  var sorted = readings.slice().sort(function(a, b) {
    return new Date(a.reading_datetime) - new Date(b.reading_datetime);
  });
  if (sorted.length < 2) {
    document.getElementById("charts-empty").classList.remove("hidden");
    document.getElementById("charts-content").classList.add("hidden");
    return;
  }
  document.getElementById("charts-empty").classList.add("hidden");
  document.getElementById("charts-content").classList.remove("hidden");
  var labels = sorted.map(function(r) { return fmtShort(r.reading_datetime); });
  var sysData = sorted.map(function(r) { return +r.systolic; });
  var diaData = sorted.map(function(r) { return +r.diastolic; });
  var pulseData = sorted.map(function(r) { return r.pulse ? +r.pulse : null; });
  if (bpChart) bpChart.destroy();
  if (pulseChart) pulseChart.destroy();
  var opts = {
    responsive: true,
    plugins: { legend: { labels: { font: { size: 12 } } } },
    scales: {
      x: { ticks: { font: { size: 11 }, color: "#8A8778" } },
      y: { ticks: { font: { size: 11 }, color: "#8A8778" } }
    }
  };
  bpChart = new Chart(document.getElementById("bp-chart"), {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        { label: "Systolic", data: sysData, borderColor: "#D4573B", backgroundColor: "#D4573B33", borderWidth: 2.5, pointRadius: 4, tension: 0.3 },
        { label: "Diastolic", data: diaData, borderColor: "#3A7D5C", backgroundColor: "#3A7D5C33", borderWidth: 2.5, pointRadius: 4, tension: 0.3 }
      ]
    },
    options: opts
  });
  pulseChart = new Chart(document.getElementById("pulse-chart"), {
    type: "line",
    data: {
      labels: labels,
      datasets: [{ label: "Pulse", data: pulseData, borderColor: "#D4A03C", backgroundColor: "#D4A03C33", borderWidth: 2.5, pointRadius: 4, tension: 0.3, spanGaps: true }]
    },
    options: opts
  });
}

// ── Sleep Data ──
var sleepEntries = [];

async function loadSleepEntries() {
  try {
    var res = await fetch(SUPA_URL + "/rest/v1/sleep_entries?order=sleep_date.desc", { headers: SUPA_HEADERS });
    if (!res.ok) throw new Error("HTTP " + res.status);
    sleepEntries = await res.json();
  } catch(e) {
    console.error("Sleep fetch error:", e);
    sleepEntries = [];
  }
}

async function insertSleep(entry) {
  try {
    var res = await fetch(SUPA_URL + "/rest/v1/sleep_entries", {
      method: "POST", headers: SUPA_HEADERS, body: JSON.stringify(entry)
    });
    if (!res.ok) throw new Error("HTTP " + res.status);
    return await res.json();
  } catch(e) {
    alert("Could not save: " + e.message);
    return null;
  }
}

async function deleteSleepEntry(id) {
  try {
    await fetch(SUPA_URL + "/rest/v1/sleep_entries?id=eq." + id, {
      method: "DELETE", headers: SUPA_HEADERS
    });
  } catch(e) { console.error(e); }
  sleepEntries = sleepEntries.filter(function(s) { return s.id !== id; });
  renderSleepHistory();
}

function todayStr() {
  var d = new Date();
  return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0") + "-" + String(d.getDate()).padStart(2,"0");
}

function clearSleepForm() {
  document.getElementById("sleep-date").value = todayStr();
  document.getElementById("sleep-hrs").value = "";
  document.getElementById("sleep-min").value = "";
  document.getElementById("sleep-awake").value = "";
  document.getElementById("sleep-rem").value = "";
  document.getElementById("sleep-core").value = "";
  document.getElementById("sleep-deep").value = "";
  document.getElementById("sleep-bedtime").value = "";
  document.getElementById("sleep-waketime").value = "";
  document.getElementById("sleep-notes").value = "";
  document.getElementById("sleep-scan-msg").classList.add("hidden");
  document.getElementById("sleep-progress").classList.add("hidden");
}

async function saveSleep() {
  var hrs = parseInt(document.getElementById("sleep-hrs").value) || 0;
  var min = parseInt(document.getElementById("sleep-min").value) || 0;
  var total = hrs * 60 + min;
  if (total === 0) { alert("Enter total time asleep"); return; }
  var btn = document.getElementById("sleep-save-btn");
  btn.disabled = true; btn.textContent = "Saving...";
  var entry = {
    sleep_date: document.getElementById("sleep-date").value || todayStr(),
    total_asleep_minutes: total,
    awake_minutes: parseInt(document.getElementById("sleep-awake").value) || null,
    rem_minutes: parseInt(document.getElementById("sleep-rem").value) || null,
    core_minutes: parseInt(document.getElementById("sleep-core").value) || null,
    deep_minutes: parseInt(document.getElementById("sleep-deep").value) || null,
    bedtime: document.getElementById("sleep-bedtime").value || null,
    wake_time: document.getElementById("sleep-waketime").value || null,
    notes: document.getElementById("sleep-notes").value || null
  };
  var result = await insertSleep(entry);
  if (result) {
    await loadSleepEntries();
    clearSleepForm();
    renderSleepHistory();
  }
  btn.disabled = false; btn.textContent = "Save Sleep";
}

function fmtMins(m) {
  if (!m && m !== 0) return "--";
  var h = Math.floor(m / 60);
  var r = m % 60;
  return h > 0 ? h + "h " + r + "m" : r + "m";
}

function renderSleepHistory() {
  document.getElementById("sleep-total").textContent = sleepEntries.length + " nights";
  var list = document.getElementById("sleep-list");
  if (sleepEntries.length === 0) {
    list.innerHTML = '<div class="empty"><div class="empty-icon">&#127769;</div><div>No sleep data yet!</div></div>';
    return;
  }
  list.innerHTML = sleepEntries.map(function(s) {
    return '<div class="sleep-entry">' +
      '<div style="display:flex;justify-content:space-between;align-items:center">' +
        '<div class="sleep-date">' + fmtDate(s.sleep_date + "T12:00:00") + '</div>' +
        '<button class="reading-del" onclick="deleteSleepEntry(' + s.id + ')">x</button>' +
      '</div>' +
      '<div class="sleep-total">' + fmtMins(s.total_asleep_minutes) + ' asleep</div>' +
      (s.bedtime || s.wake_time ? '<div style="font-size:12px;color:#8A8778;margin-top:4px">' +
        (s.bedtime ? 'Bed: ' + s.bedtime : '') +
        (s.bedtime && s.wake_time ? ' &rarr; ' : '') +
        (s.wake_time ? 'Wake: ' + s.wake_time : '') +
      '</div>' : '') +
      '<div class="sleep-stages">' +
        (s.awake_minutes ? '<span class="sleep-stage stage-awake">Awake ' + s.awake_minutes + 'm</span>' : '') +
        (s.rem_minutes ? '<span class="sleep-stage stage-rem">REM ' + fmtMins(s.rem_minutes) + '</span>' : '') +
        (s.core_minutes ? '<span class="sleep-stage stage-core">Core ' + fmtMins(s.core_minutes) + '</span>' : '') +
        (s.deep_minutes ? '<span class="sleep-stage stage-deep">Deep ' + fmtMins(s.deep_minutes) + '</span>' : '') +
      '</div>' +
      (s.notes ? '<div class="reading-notes">' + s.notes.replace(/</g,'&lt;') + '</div>' : '') +
    '</div>';
  }).join("");
}

// ── Sleep OCR ──
function showSleepScanMsg(text, type) {
  var el = document.getElementById("sleep-scan-msg");
  el.textContent = text;
  el.className = "scan-msg " + type;
  el.classList.remove("hidden");
}

function showSleepProgress(pct) {
  var bar = document.getElementById("sleep-progress");
  bar.classList.remove("hidden");
  document.getElementById("sleep-progress-fill").style.width = pct + "%";
}

async function handleSleepPhoto(input) {
  var file = input.files && input.files[0];
  if (!file) return;
  input.value = "";
  var apiKey = getApiKey();
  if (!apiKey || !apiKey.startsWith("sk-")) {
    showSleepScanMsg("Set your API key first (scroll down)", "error");
    return;
  }
  showSleepScanMsg("Compressing...", "scanning");
  showSleepProgress(20);
  try {
    var dataUrl = await new Promise(function(resolve, reject) {
      var reader = new FileReader();
      reader.onload = function() { resolve(reader.result); };
      reader.onerror = function() { reject(new Error("Could not read")); };
      reader.readAsDataURL(file);
    });
    showSleepScanMsg("Reading sleep data...", "scanning");
    showSleepProgress(50);
    var base64 = await compressImage(dataUrl);
    if (!base64) { showSleepScanMsg("Could not process image", "error"); return; }
    var res = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": apiKey,
        "anthropic-version": "2023-06-01",
        "anthropic-dangerous-direct-browser-access": "true"
      },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 400,
        messages: [{
          role: "user",
          content: [
            { type: "image", source: { type: "base64", media_type: "image/jpeg", data: base64 } },
            { type: "text", text: "This is a screenshot of the Apple Health sleep screen. Extract the data shown. Return ONLY a JSON object with these fields: {\"date\":\"YYYY-MM-DD\",\"total_hours\":NUMBER,\"total_minutes\":NUMBER,\"awake_minutes\":NUMBER,\"rem_minutes\":NUMBER,\"core_minutes\":NUMBER,\"deep_minutes\":NUMBER,\"bedtime\":\"TIME\",\"wake_time\":\"TIME\"}. For stage times in hours and minutes like '2 hr 42 min', convert to total minutes (162). Use null for anything not visible. Return ONLY the JSON." }
          ]
        }]
      })
    });
    showSleepProgress(80);
    if (!res.ok) {
      var errText = await res.text();
      showSleepScanMsg("API error " + res.status + ": " + errText.slice(0, 150), "error");
      document.getElementById("sleep-progress").classList.add("hidden");
      return;
    }
    var data = await res.json();
    showSleepProgress(100);
    var txt = data.content.map(function(b) { return b.text || ""; }).join("");
    var result = JSON.parse(txt.replace(/```json|```/g, "").trim());
    if (result.date) document.getElementById("sleep-date").value = result.date;
    if (result.total_hours != null) document.getElementById("sleep-hrs").value = result.total_hours;
    if (result.total_minutes != null) document.getElementById("sleep-min").value = result.total_minutes;
    if (result.awake_minutes != null) document.getElementById("sleep-awake").value = result.awake_minutes;
    if (result.rem_minutes != null) document.getElementById("sleep-rem").value = result.rem_minutes;
    if (result.core_minutes != null) document.getElementById("sleep-core").value = result.core_minutes;
    if (result.deep_minutes != null) document.getElementById("sleep-deep").value = result.deep_minutes;
    if (result.bedtime) document.getElementById("sleep-bedtime").value = result.bedtime;
    if (result.wake_time) document.getElementById("sleep-waketime").value = result.wake_time;
    showSleepScanMsg("Got it! Check the numbers and save.", "success");
  } catch(err) {
    showSleepScanMsg("Error: " + (err.message || err), "error");
  }
  document.getElementById("sleep-progress").classList.add("hidden");
}

// Init
document.getElementById("datetime").value = localNow();
document.getElementById("sleep-date").value = todayStr();
document.getElementById("api-key").value = getApiKey();
updateApiStatus();
if (!getApiKey()) document.getElementById("settings-panel").classList.remove("hidden");
loadReadings().then(renderHistory);
</script>
</body>
</html>
